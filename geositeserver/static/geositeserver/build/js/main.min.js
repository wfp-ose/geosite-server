var buildGroupsAndColumnsForCountry=function(e,a){var t=[[]],o=[];if("cyclone"==e.hazard)$.each(a.data.summary.prob_class,function(e,a){var r=a.by_month;o.push([e].concat(r)),t[0].push(e)});else if("drought"==e.hazard){for(var r=0;r<e.groups.length;r++){var n=e.group_prefix,s=e.group_key,i=e.group_modifier,l=e.groups[r],p=a.data.summary[s][""+l*i].by_month;o.push([n+l].concat(p)),t[0].push(n+l)}o.reverse()}else if("flood"==e.hazard){for(var r=0;r<e.groups.length;r++){var n=e.group_prefix,s=e.group_key,l=e.groups[r],i=e.group_modifier,p=a.data.summary[s][""+l*i].by_month;o.push([n+l].concat(p)),t[0].push(n+l)}o.reverse()}return{groups:t,columns:o}},buildGroupsAndColumnsForAdmin2=function(e,a,t){var o=[[]],r=[];if("flood"==e.hazard){for(var n=0;n<e.returnPeriods.length;n++){var s=e.returnPeriods[n],i=a.data.summary.admin2[t].rp[""+s].by_month;r.push(["rp"+s].concat(i)),o[0].push("rp"+s)}r.reverse()}else"cyclone"==e.hazard&&$.each(a.data.summary.admin2[t].prob_class,function(e,a){var t=a.by_month;r.push([e].concat(t)),o[0].push(e)});return{groups:o,columns:r}},buildHazardChart=function(e,a,t){var o=void 0;if("bar"==e.type){o=void 0!=t&&void 0!=t.groups&&void 0!=t.columns?{groups:t.groups,columns:t.columns}:buildGroupsAndColumnsForCountry(e,a);var r=void 0;"bullet"==e.subtype?(r={bullet:!0,width:function(e,a){return"rp25"==e.id?8:16},offset:function(e,a){return 0}},void 0!=t&&void 0!=t.bullet_width&&(r.width=t.bullet_width)):r={width:{ratio:.6}};var n={x:{},y:{}};void 0!=e.axis&&void 0!=e.axis.x&&"months"==e.axis.x.type&&(n.x.tick={format:function(e){return months_short_3[e].toTitleCase()}}),n.y.label=e.axis.y.label,n.y.tick={format:d3.format("s,")};c3.generate({bindto:"#"+e.id,data:{columns:o.columns,groups:o.groups,type:"bar",colors:e.colors},axis:n,bar:r})}},init_start=function(e){init_summary(e)},init_summary=function(e){var a=map_config.featurelayers.popatrisk.urls.summary.replace("{iso3}",sparc.state.iso3).replace("{hazard}",sparc.state.hazard);$.ajax({dataType:"json",url:a,success:function(a){sparc.layers.popatrisk.data.summary=a,init_geojson(e)}})},init_geojson=function(e){var a=map_config.featurelayers.popatrisk.urls.geojson.replace("{iso3}",sparc.state.iso3).replace("{hazard}",sparc.state.hazard);$.ajax({dataType:"json",url:a,success:function(a){sparc.layers.popatrisk.data.geojson=a,init_main_app(e)}})},init_main_app=function(e){sparcApp=app=angular.module(e,["ngRoute"]),app.factory("state",function(){return $.extend({},sparc.state)}),app.factory("stateschema",function(){return $.extend({},sparc.stateschema)}),app.factory("popatrisk_config",function(){return $.extend({},sparc.layers.popatrisk)}),app.factory("map_config",function(){return $.extend({},map_config)}),app.factory("live",function(){return{map:void 0,baselayers:{},featurelayers:{popatrisk:void 0}}}),geosite.init_controller_base(app),init_sparc_controller_main($(".geosite-controller.geosite-main"),app),angular.bootstrap(document,[e])},init_sparc_controller=function(e,a){var t=e.data("controllerName");e.data("controllerType");a.controller(t,function(e,a){init_intents($(a),e)})};geosite.controller_main=function(e,a,t,o,r,n,s){e.state=geosite.init_state(o,r),e.live=s,e.$on("stateChanged",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.$apply(function(){t.state=$.extend(t.state,a);var e=buildPageURL("countryhazardmonth_detail",t.state);history.replaceState(o,"",e),t.$broadcast("refreshMap",{state:t.state})})}),e.$on("filterChanged",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.$apply(function(){t.state.filters[a.layer]=$.extend(t.state.filters[a.layer],a.filter);var e=buildPageURL("countryhazardmonth_detail",t.state);history.replaceState(o,"",e),t.$broadcast("refreshMap",{state:t.state})})}),e.$on("viewChanged",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.state.view=$.extend(t.state.view,a);var r=buildPageURL("countryhazardmonth_detail",t.state);history.replaceState(o,"",r)}),e.$on("layerLoaded",function(e,a){var t=angular.element("#geosite-main").scope(),o=a.layer;t.state.view.featurelayers.push(o)}),e.$on("showLayer",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope(),o=a.layer;-1==$.inArray(o,t.state.view.featurelayers)&&(t.state.view.featurelayers.push(o),t.$broadcast("refreshMap",{state:t.state}))}),e.$on("hideLayer",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope(),o=a.layer,r=$.inArray(o,t.state.view.featurelayers);-1!=r&&(t.state.view.featurelayers.splice(r,1),t.$broadcast("refreshMap",{state:t.state}))}),e.$on("switchBaseLayer",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.state.view.baselayer=a.layer,t.$broadcast("refreshMap",{state:t.state})}),e.$on("zoomToLayer",function(e,a){var t=angular.element("#geosite-main").scope(),o=a.layer,r=$.inArray(o,t.state.view.featurelayers);-1!=r&&t.$broadcast("changeView",{layer:o})})};var init_sparc_controller_main=function(e,a){geosite.init_controller(e,a,geosite.controller_main),$(".geosite-controller.geosite-sidebar",e).each(function(){geosite.init_controller($(this),a,geosite.controller_sidebar)}),$(".geosite-controller.geosite-map",e).each(function(){geosite.init_controller($(this),a,geosite.controller_map),geosite.init_controllers($(this),a,[{selector:".geosite-controller.geosite-map-map",controller:geosite.controller_map_map},{selector:".geosite-controller.sparc-map-calendar",controller:void 0},{selector:".geosite-controller.sparc-map-breadcrumb",controller:geosite.controller_breadcrumb},{selector:".geosite-controller.geosite-map-filter",controller:geosite.controller_filter},{selector:".geosite-controller.geosite-map-legend",controller:void 0}])})};geosite.controller_map=function(e,a,t,o,r,n){},geosite.controller_breadcrumb=function(e,a,t,o){angular.extend(this,t("GeositeControllerBase",{$element:a,$scope:e})),$("select",a).each(function(){var a=$(this),t=a.data("breadcrumbs"),r=a.data("placeholder"),n=a.data("initialData"),s=a.data("width"),i=a.data("height"),l="sparc-select-dropdown";a.select2({data:sparc.data[n],placeholder:r,allowClear:!1,width:s,height:i,dropdownCssClass:l}),a.on("select2:select",function(r){var n=r.params.data.id;e.$apply(function(){var t=a.data("output");e.state[t]=n});for(var s="",i=0;i<t.length;i++){var l=t[i];void 0!=o[l.value]&&(s+="/"+l.name+"/"+e.state[l.value])}console.log("Going to url ",s),window.location.href=s})})},geosite.controller_filter=function(e,a,t,o,r,n,s){var i=r.data.summary.all.max.at_admin2_month;angular.extend(this,t("GeositeControllerBase",{$element:a,$scope:e})),$(a).on("change",'input:radio[name="cat"]',function(a){console.log(a);var t=$(this).data("output"),o={};o[t]=this.value,geosite.intend("filterChanged",{layer:"popatrisk",filter:o},e)}),$(".geosite-filter-slider",$(a)).each(function(){var a=$(this).find(".geosite-filter-slider-slider"),t=$(this).find(".geosite-filter-slider-label"),r=a.data("type"),n=a.data("output");if("ordinal"==r){var s=a.data("range"),l=o.filters.popatrisk[n],p=a.data("options");a.data("label",t),geosite.ui_init_slider_label(a,r,s,l),geosite.ui_init_slider_slider(e,a,r,s,p.indexOf(l),0,p.length-1,1)}else{var s=a.data("range"),c=geosite.assert_float(a.data("min-value"),void 0),u=a.data("step");if("true"==s.toLowerCase()){var d=void 0!=i?i:geosite.assert_float(a.data("max-value"),void 0),g=o.filters.popatrisk[n];g=geosite.assert_array_length(g,2,[c,d]);var m=[Math.floor(g[0]),Math.floor(g[1])],f=Math.floor(c),h=Math.floor(d),y=Math.floor(u);a.data("label",t),geosite.ui_init_slider_label(a,r,s,g),geosite.ui_init_slider_slider(e,a,r,s,m,f,h,y),console.log(v,f,h,y,s)}else{var d=geosite.assert_float(a.data("max-value"),void 0),l=o.filters.popatrisk[n],v=Math.floor(100*l),f=Math.floor(100*c),h=Math.floor(100*d),y=Math.floor(100*u);a.data("label",t),geosite.ui_init_slider_label(a,r,s,l),geosite.ui_init_slider_slider(e,a,r,s,m,f,h,y),console.log(v,f,h,y,s)}}})};var init_map=function(e){var a=L.map("map",{zoomControl:opt_b(e,"zoom",!1),minZoom:opt_i(e,"minZoom",3),maxZoom:opt_i(e,"maxZoom",18)});return a.setView([opt_i(e,["latitude","lat"],0),opt_i(e,["longitude","lon","lng","long"],0)],opt_i(e,["zoom","z"],0)),$.each(opt_j(e,"listeners"),function(e,t){a.on(e,t)}),a},init_baselayers=function(e,a){for(var t={},o=0;o<a.length;o++){var r=a[o];try{t[r.id]=L.tileLayer(r.source.url,{id:r.id,attribution:r.source.attribution})}catch(n){console.log("Could not add baselayer "+o)}}return t};geosite.controller_map_map=function(e,a,t,o,r,n,s){var i={zoomend:function(a){var t={extent:s.map.getBounds().toBBoxString(),z:s.map.getZoom()};geosite.intend("viewChanged",t,e)},dragend:function(a){var t=s.map.getCenter(),o={extent:s.map.getBounds().toBBoxString(),lat:t.lat,lon:t.lng};geosite.intend("viewChanged",o,e)},moveend:function(a){var t=s.map.getCenter(),o={extent:s.map.getBounds().toBBoxString(),lat:t.lat,lon:t.lng};geosite.intend("viewChanged",o,e)}},l=hasHashValue(["latitude","lat","longitude","lon","lng","zoom","z"]),p=o.view;s.map=init_map({zoom:n.controls.zoom,minZoom:n.view.minZoom,maxZoom:n.view.maxZoom,lat:p.lat,lon:p.lon,z:p.z,listeners:i});var c=init_baselayers(s.map,n.baselayers);$.extend(s.baselayers,c);var u=n.baselayers[0].id;s.baselayers[u].addTo(s.map),geosite.intend("viewChanged",{baselayer:u},e),geosite.intend("layerLoaded",{layer:u},e);var d=function(e){console.log(e);var a=e.feature,o=angular.element("#geosite-main").scope(),s=o.state,i=s.filters.popatrisk,l=popup_templates.popatrisk,p=$.extend({},a.properties),c=months_short_3[s.month-1],u=months_long[s.month-1];if(p.month=u,"flood"==s.hazard){var d=i.rp;p.popatrisk=a.properties["RP"+d.toString(10)][c]}else if("cyclone"==s.hazard){for(var g=i.prob_class_max,m=0,f=0;f<a.properties.addinfo.length;f++){var h=a.properties.addinfo[f];h.category==i.category&&0!=h.prob_class_max&&h.prob_class_max<=g&&(console.log("matched prob_class",g),m+=h[c])}p.popatrisk=m}var y=n.featurelayers.popatrisk.popup.chart;return p.chartID=y.id,setTimeout(function(){var e=buildGroupsAndColumnsForAdmin2(y,r,a.properties.admin2_code),t={groups:e.groups,columns:e.columns,bullet_width:function(e,a){return"rp25"==e.id?6:12}};buildHazardChart(y,r,t)},1e3),t(l)(p)};s.featurelayers.popatrisk=L.geoJson(r.data.geojson,{renderOrder:$.inArray("popatrisk",n.renderlayers),style:r.style["default"],hoverStyle:r.style.hover,onEachFeature:function(e,a){var t={maxWidth:300};a.bindPopup(d,t),a.on({mouseover:highlightFeature,mouseout:function(e){s.featurelayers.popatrisk.resetStyle(e.target)},click:function(e){}})}}),$.each(n.featurelayers,function(e,a){if("popatrisk"!=e&&(void 0==a.enabled||1==a.enabled)&&"wms"==a.type.toLowerCase()){var t=a.wms,o=L.tileLayer.wms(t.url,{renderOrder:$.inArray(e,n.renderlayers),buffer:t.buffer||0,version:t.version||"1.1.1",layers:t.layers.join(","),styles:t.styles?t.styles.join(","):"",format:t.format,transparent:t.transparent||!1,attribution:a.source});s.featurelayers[e]=o}}),$.each(s.featurelayers,function(a,t){t.addTo(s.map),geosite.intend("layerLoaded",{layer:a},e)}),l||s.map.fitBounds(s.featurelayers.popatrisk.getBounds()),$("#geosite-map-sidebar-toggle").click(function(){$(this).toggleClass("sidebar-open"),$("#geosite-sidebar, #geosite-map").toggleClass("sidebar-open"),setTimeout(function(){s.map.invalidateSize({animate:!0,pan:!1})},2e3)}),e.$on("refreshMap",function(e,a){console.log("Refreshing map...");var t=a.state.view.baselayer;$.each(s.baselayers,function(e,a){var o=e==t;s.map.hasLayer(a)&&!o?s.map.removeLayer(a):!s.map.hasLayer(a)&&o&&s.map.addLayer(a)});var o=a.state.view.featurelayers;$.each(s.featurelayers,function(e,a){var t=-1!=$.inArray(e,o);s.map.hasLayer(a)&&!t?s.map.removeLayer(a):!s.map.hasLayer(a)&&t&&s.map.addLayer(a)});var n=$.grep(layersAsArray(s.featurelayers),function(e){return-1!=$.inArray(e.id,o)}),i=sortLayers($.map(n,function(e,a){return e.layer}),!0),l=($.map(s.baselayers,function(e,a){return{id:a,layer:e}}),$.map($.grep(layersAsArray(s.baselayers),function(e){return e.id==t}),function(e,a){return e.layer}));updateRenderOrder(l.concat(i)),s.featurelayers.popatrisk.setStyle(r.style["default"]),setTimeout(function(){s.map._onResize()},0)}),e.$on("changeView",function(e,a){console.log("Refreshing map..."),void 0!=a.layer&&s.map.fitBounds(s.featurelayers[a.layer].getBounds())})},geosite.controller_sidebar=function(e,a,t,o,r,n,s){angular.extend(this,t("GeositeControllerBase",{$element:a,$scope:e}));$(a);if(void 0!=n.charts)for(var i=0;i<n.charts.length;i++){var l={};"drought"==n.charts[i].hazard&&(l.bullet_width=function(e,a){return"p6"==e.id?6:"p8"==e.id?8:16}),buildHazardChart(n.charts[i],r,l)}},geosite.style_cyclone=function(e,a,t,o){for(var r={},n=a.filters.popatrisk,s=n.prob_class_max,i=n.popatrisk_range,l=months_short_3[a.month-1],p=0,c=0;c<e.properties.addinfo.length;c++){var u=e.properties.addinfo[c];u.category==n.category&&0!=u.prob_class_max&&u.prob_class_max<=s&&(console.log("matched prob_class",s),p+=u[l])}if(p>=i[0]&&p<=i[1]){for(var d=t.featurelayers.popatrisk.symbology.colors,g=o.data.summary.all.breakpoints.natural,m=void 0,c=0;c<g.length;c++)if(p<g[c]){m=d[c];break}r.fillColor=void 0==m?d[d.length-1]:m}else r.opacity=0,r.fillOpacity=0;return r},geosite.style_drought=function(e,a,t,o){for(var r={},n=a.filters.popatrisk,s=n.prob_class_max/100,i=n.popatrisk_range,l=months_short_3[a.month-1],p=0,c=0;c<e.properties.addinfo.length;c++){var u=e.properties.addinfo[c];u.month==l&&u.prob<s&&(p+=u.popatrisk)}if(p>=i[0]&&p<=i[1]){for(var d=t.featurelayers.popatrisk.symbology.colors,g=o.data.summary.all.breakpoints.natural,m=void 0,c=0;c<g.length;c++)if(p<g[c]){m=d[c];break}r.fillColor=void 0==m?d[d.length-1]:m}else r.opacity=0,r.fillOpacity=0;return r},geosite.style_flood=function(e,a,t,o){var r={},n=a.filters.popatrisk,s=n.rp,i=n.popatrisk_range,l=months_short_3[a.month-1],p=e.properties["RP"+s.toString(10)][l];if(p>=i[0]&&p<=i[1]){for(var c=t.featurelayers.popatrisk.symbology.colors,u=o.data.summary.all.breakpoints.natural_adjusted,d=void 0,g=0;g<u.length;g++)if(p<u[g]){d=c[g];break}r.fillColor=void 0==d?c[c.length-1]:d}else r.opacity=0,r.fillOpacity=0;return r};var buildPageURL=function(e,a){var t=sparc.pages[e].url.replace("{iso3}",a.iso3).replace("{hazard}",a.hazard).replace("{month}",a.month),o=[],r=a.view;void 0!=r&&void 0!=r.z&&void 0!=r.lat&&void 0!=r.lon&&(o.push("z="+r.z),o.push("lat="+r.lat.toFixed(4)),o.push("lon="+r.lon.toFixed(4)));var n=a.filters;return n&&$.each(a.filters,function(e,a){$.each(a,function(a,t){o.push(e+":"+a+"="+t)})}),o.length>0&&(t+="#"+o.join("&")),t};