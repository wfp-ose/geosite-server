var init_start=function(e){init_main_app(e)},init_main_app=function(e){geosite.app=app=angular.module(e,["ngRoute"]),app.factory("state",function(){return $.extend({},geosite.initial_data.state)}),app.factory("stateschema",function(){return $.extend({},geosite.initial_data.stateschema)}),app.factory("map_config",function(){return $.extend({},map_config)}),app.factory("live",function(){return{map:void 0,baselayers:{},featurelayers:{}}}),geosite.init_controller_base(app),init_sparc_controller_main($(".geosite-controller.geosite-main"),app),angular.bootstrap(document,[e])},init_sparc_controller=function(e,a){var t=e.data("controllerName");e.data("controllerType");a.controller(t,function(e,a){init_intents($(a),e)})};geosite.controller_main=function(e,a,t,o,n,r){e.state=geosite.init_state(o,n),e.live=r,e.$on("stateChanged",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.$apply(function(){t.state=$.extend(t.state,a);var e=buildPageURL(t.state.page,t.state);history.replaceState(o,"",e),t.$broadcast("refreshMap",{state:t.state})})}),e.$on("filterChanged",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.$apply(function(){t.state.filters[a.layer]=$.extend(t.state.filters[a.layer],a.filter);var e=buildPageURL(t.state.page,t.state);history.replaceState(o,"",e),t.$broadcast("refreshMap",{state:t.state})})}),e.$on("viewChanged",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.state.view=$.extend(t.state.view,a);var n=buildPageURL(t.state.page,t.state);history.replaceState(o,"",n)}),e.$on("layerLoaded",function(e,a){var t=angular.element("#geosite-main").scope(),o=a.layer;t.state.view.featurelayers.push(o)}),e.$on("showLayer",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope(),o=a.layer;-1==$.inArray(o,t.state.view.featurelayers)&&(t.state.view.featurelayers.push(o),t.$broadcast("refreshMap",{state:t.state}))}),e.$on("hideLayer",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope(),o=a.layer,n=$.inArray(o,t.state.view.featurelayers);-1!=n&&(t.state.view.featurelayers.splice(n,1),t.$broadcast("refreshMap",{state:t.state}))}),e.$on("switchBaseLayer",function(e,a){console.log("event",e),console.log("args",a);var t=angular.element("#geosite-main").scope();t.state.view.baselayer=a.layer,t.$broadcast("refreshMap",{state:t.state})}),e.$on("zoomToLayer",function(e,a){var t=angular.element("#geosite-main").scope(),o=a.layer,n=$.inArray(o,t.state.view.featurelayers);-1!=n&&t.$broadcast("changeView",{layer:o})})};var init_sparc_controller_main=function(e,a){geosite.init_controller(e,a,geosite.controller_main),$(".geosite-controller.geosite-sidebar",e).each(function(){geosite.init_controller($(this),a,geosite.controller_sidebar)}),$(".geosite-controller.geosite-map",e).each(function(){geosite.init_controller($(this),a,geosite.controller_map),geosite.init_controllers($(this),a,[{selector:".geosite-controller.geosite-map-map",controller:geosite.controller_map_map},{selector:".geosite-controller.geosite-map-legend",controller:void 0}])})};geosite.controller_map=function(e,a,t,o,n){};var init_map=function(e){var a=L.map("map",{zoomControl:opt_b(e,"zoomControl",!1),minZoom:opt_i(e,"minZoom",3),maxZoom:opt_i(e,"maxZoom",18)});return a.setView([opt_i(e,["latitude","lat"],0),opt_i(e,["longitude","lon","lng","long"],0)],opt_i(e,["zoom","z"],0)),$.each(opt_j(e,"listeners"),function(e,t){a.on(e,t)}),a},init_baselayers=function(e,a){for(var t={},o=0;o<a.length;o++){var n=a[o];try{t[n.id]=L.tileLayer(n.source.url,{id:n.id,attribution:n.source.attribution})}catch(r){console.log("Could not add baselayer "+o)}}return t};geosite.controller_map_map=function(e,a,t,o,n,r){var i={zoomend:function(a){var t={extent:r.map.getBounds().toBBoxString(),z:r.map.getZoom()};geosite.intend("viewChanged",t,e)},dragend:function(a){var t=r.map.getCenter(),o={extent:r.map.getBounds().toBBoxString(),lat:t.lat,lon:t.lng};geosite.intend("viewChanged",o,e)},moveend:function(a){var t=r.map.getCenter(),o={extent:r.map.getBounds().toBBoxString(),lat:t.lat,lon:t.lng};geosite.intend("viewChanged",o,e)}},s=(hasHashValue(["latitude","lat","longitude","lon","lng","zoom","z"]),o.view);r.map=init_map({zoomControl:n.controls.zoom,minZoom:n.view.minZoom,maxZoom:n.view.maxZoom,lat:s.lat,lon:s.lon,z:s.z,listeners:i});var l=init_baselayers(r.map,n.baselayers);$.extend(r.baselayers,l);var c=n.baselayers[0].id;r.baselayers[c].addTo(r.map),geosite.intend("viewChanged",{baselayer:c},e),geosite.intend("layerLoaded",{layer:c},e),$.each(n.featurelayers,function(e,a){if((void 0==a.enabled||1==a.enabled)&&"wms"==a.type.toLowerCase()){var t=a.wms,o=L.tileLayer.wms(t.url,{renderOrder:$.inArray(e,n.renderlayers),buffer:t.buffer||0,version:t.version||"1.1.1",layers:t.layers.join(","),styles:t.styles?t.styles.join(","):"",format:t.format,transparent:t.transparent||!1,attribution:a.source});r.featurelayers[e]=o}}),$.each(r.featurelayers,function(a,t){void 0!=t?(t.addTo(r.map),geosite.intend("layerLoaded",{layer:a},e)):console.log("Could not add featurelayer "+a+" because it is undefined.")}),e.$on("refreshMap",function(e,a){console.log("Refreshing map...");var t=a.state.view.baselayer;$.each(r.baselayers,function(e,a){var o=e==t;r.map.hasLayer(a)&&!o?r.map.removeLayer(a):!r.map.hasLayer(a)&&o&&r.map.addLayer(a)});var o=a.state.view.featurelayers;$.each(r.featurelayers,function(e,a){var t=-1!=$.inArray(e,o);r.map.hasLayer(a)&&!t?r.map.removeLayer(a):!r.map.hasLayer(a)&&t&&r.map.addLayer(a)});var n=$.grep(layersAsArray(r.featurelayers),function(e){return-1!=$.inArray(e.id,o)}),i=sortLayers($.map(n,function(e,a){return e.layer}),!0),s=($.map(r.baselayers,function(e,a){return{id:a,layer:e}}),$.map($.grep(layersAsArray(r.baselayers),function(e){return e.id==t}),function(e,a){return e.layer}));updateRenderOrder(s.concat(i)),setTimeout(function(){r.map._onResize()},0)}),e.$on("changeView",function(e,a){console.log("Refreshing map..."),void 0!=a.layer&&r.map.fitBounds(r.featurelayers[a.layer].getBounds())})};var buildPageURL=function(e,a){var t=geosite.initial_data.pages[e].url.replace("{iso3}",a.iso3).replace("{hazard}",a.hazard).replace("{month}",a.month),o=[],n=a.view;void 0!=n&&void 0!=n.z&&void 0!=n.lat&&void 0!=n.lon&&(o.push("z="+n.z),o.push("lat="+n.lat.toFixed(4)),o.push("lon="+n.lon.toFixed(4)));var r=a.filters;return r&&$.each(a.filters,function(e,a){$.each(a,function(a,t){o.push(e+":"+a+"="+t)})}),o.length>0&&(t+="#"+o.join("&")),t};